<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SMART MAINTENANCE BOWLING</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');

    body, html {
      height: 100%;
      margin: 0;
      font-family: "Poppins", sans-serif;
      background-color: #f4f6f9;
      color: #1a2f40;
    }

    #app-content {
      width: 100%;
      padding: 20px;
      box-sizing: border-box;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background-color: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    th, td {
      padding: 12px;
      text-align: center;
      font-size: 16px;
      font-weight: 600;
    }

    th {
      background-color: #1a2f40;
      color: white;
      font-size: 18px;
      text-transform: uppercase;
      cursor: pointer;
    }

    tbody tr:nth-child(even) {
      background-color: #eef2f7;
    }

    tbody tr:hover {
      background-color: #dde2eb;
    }

    .schema-button {
      background-color: #1a2f40;
      color: white;
      padding: 10px 15px;
      font-size: 16px;
      font-weight: 700;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.2s ease;
    }

    .schema-button:hover {
      background-color: #143055;
    }

    select {
      width: 95%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: white;
      font-size: 16px;
      text-align: center;
    }

    select:hover {
      border-color: #1a2f40;
    }

    button {
      background-color: #dc143c;
      color: white;
      padding: 10px 15px;
      font-size: 16px;
      font-weight: 700;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    button:hover {
      background-color: #a90e2e;
    }

    button:active {
      transform: scale(0.97);
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 20px;
      gap: 20px;
      flex-wrap: wrap;
    }

    #pageNumbers button {
      background-color: #dc143c;
      color: white;
      font-weight: 700;
      border: none;
      border-radius: 6px;
      padding: 10px 15px;
      cursor: pointer;
    }

    #pageNumbers button.active {
      background-color: #1a2f40;
    }

    .highlight {
      background-color: #dc143c !important;
      color: white !important;
    }
  </style>
</head>
<body>

<div id="app-content" style="display:none;">
  <table>
    <thead>
      <tr>
        <th onclick="startColumnSearch(0)">ЗАДАЧА</th>
        <th onclick="startColumnSearch(1)">МАШИНА</th>
        <th onclick="startColumnSearch(2)">ОТКРЫТА</th>
        <th onclick="startColumnSearch(3)">ЗАКРЫТА</th>
        <th onclick="startColumnSearch(4)">ВЫПОЛНИЛ</th>
        <th onclick="startColumnSearch(5)">ПОЛОМКА</th>
        <th>ОТПРАВИТЬ</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <div class="pagination">
    <button onclick="prevPage()" id="prevBtn" disabled>← Назад</button>
    <div id="pageNumbers" style="display: flex; gap: 10px;"></div>
    <button onclick="nextPage()" id="nextBtn">Вперёд →</button>
  </div>
</div>

<script>
  let fullData = [];
  let currentPage = 1;
  const rowsPerPage = 20;

  // Поиск
  let activeSearchColumn = null;
  let activeSearchText = "";

  window.onload = function () {
    document.getElementById("app-content").style.display = "block";
    loadSheetData();
  };

  function loadSheetData() {
    google.script.run.withSuccessHandler(function (response) {
      try {
        fullData = JSON.parse(response) || [];
      } catch (e) {
        document.getElementById("tableBody").innerHTML = "<tr><td colspan='7'>Ошибка загрузки данных</td></tr>";
        return;
      }

      if (fullData.length === 0) {
        document.getElementById("tableBody").innerHTML = "<tr><td colspan='7'>Нет задач</td></tr>";
        return;
      }

      renderPage(currentPage);
    }).getSheetData();
  }

  function renderPage(page) {
    const tableBody = document.getElementById("tableBody");
    tableBody.innerHTML = "";

    const start = (page - 1) * rowsPerPage;
    const end = start + rowsPerPage;
    let pageData = fullData.slice(start, end);

    // Применяем поиск, если активен
    if (activeSearchColumn !== null && activeSearchText !== "") {
      pageData = pageData.filter(row => {
        const cellText = row[activeSearchColumn + 1] ? row[activeSearchColumn + 1].toString().toLowerCase() : "";
        return cellText.includes(activeSearchText);
      });
    }

    if (pageData.length === 0) {
      tableBody.innerHTML = "<tr><td colspan='7'>Нет данных для отображения</td></tr>";
      return;
    }

    pageData.forEach((row) => {
      const tr = document.createElement("tr");
      const schemaLink = row[2] ? `<a href="${row[2]}" target="_blank"><button class="schema-button">Открыть</button></a>` : "Нет схемы";
      tr.innerHTML = `<td>${schemaLink}</td><td>${row[1]}</td>`;
      tr.innerHTML += `<td>${row[3]}</td><td>${row[4]}</td>`;

      const doneBy = row[5] ? row[5] : "";
      const breakdown = row[6] ? row[6] : "";

      tr.innerHTML += doneBy
        ? `<td>${doneBy}</td>`
        : `<td id="gText_${row[0]}"><select id="g_${row[0]}">
              <option value="" selected disabled></option>
              <option value="Дима">Дима</option>
              <option value="Женя">Женя</option>
          </select></td>`;

      tr.innerHTML += breakdown
        ? `<td>${breakdown}</td>`
        : `<td id="iText_${row[0]}"><select id="i_${row[0]}">
              <option value="" selected disabled></option>
              <option value="ЕСТЬ">ЕСТЬ</option>
              <option value="НЕТ">НЕТ</option>
          </select></td>`;

      tr.innerHTML += `<td><button id="btn_${row[0]}" onclick="validateAndSend(${row[0]});">Отправить</button></td>`;
      tableBody.appendChild(tr);
    });

    renderPageNumbers();

    document.getElementById("prevBtn").disabled = currentPage === 1;
    document.getElementById("nextBtn").disabled = currentPage * rowsPerPage >= fullData.length;
  }

  function renderPageNumbers() {
    const pageContainer = document.getElementById("pageNumbers");
    pageContainer.innerHTML = "";

    const totalPages = Math.ceil(fullData.length / rowsPerPage);
    let startPage = Math.max(currentPage - 2, 1);
    let endPage = Math.min(startPage + 4, totalPages);

    if (endPage - startPage < 4) {
      startPage = Math.max(endPage - 4, 1);
    }

    for (let i = startPage; i <= endPage; i++) {
      const btn = document.createElement("button");
      btn.textContent = i;
      if (i === currentPage) btn.classList.add("active");
      btn.onclick = () => {
        currentPage = i;
        renderPage(currentPage);
      };
      pageContainer.appendChild(btn);
    }
  }

  function nextPage() {
    if (currentPage * rowsPerPage < fullData.length) {
      currentPage++;
      renderPage(currentPage);
    }
  }

  function prevPage() {
    if (currentPage > 1) {
      currentPage--;
      renderPage(currentPage);
    }
  }

  function validateAndSend(rowNumber) {
    const gSelect = document.getElementById(`g_${rowNumber}`);
    const iSelect = document.getElementById(`i_${rowNumber}`);

    if (!gSelect || !iSelect || !gSelect.value || !iSelect.value) {
      alert("Заполните все формы!");
      return;
    }

    updateSheet(rowNumber, gSelect.value, iSelect.value);
  }

  function updateSheet(rowNumber, doneByValue, breakdownValue) {
    google.script.run.withSuccessHandler((updatedRow) => {
      // Обновляем локальный массив fullData с новой строкой
      const index = fullData.findIndex(row => row[0] === rowNumber);
      if (index !== -1) {
        fullData[index] = updatedRow;
      }
      renderPage(currentPage);
    }).updateSheet(rowNumber, doneByValue, breakdownValue);
  }

  function startColumnSearch(columnIndex) {
    const searchText = prompt("Введите текст для поиска:");
    if (searchText === null || searchText.trim() === "") {
      activeSearchColumn = null;
      activeSearchText = "";
    } else {
      activeSearchColumn = columnIndex;
      activeSearchText = searchText.trim().toLowerCase();
    }
    renderPage(currentPage);
  }
</script>

</body>
</html>
