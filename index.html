<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SMART MAINTENANCE BOWLING</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');

  body, html {
    margin: 0; padding: 0;
    font-family: "Poppins", sans-serif;
    background-color: #f4f6f9;
    color: #1a2f40;
  }

  /* ОБЩИЕ СТИЛИ ТАБЛИЦЫ */
  table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  th, td {
    padding: 12px;
    text-align: center;
    font-weight: 600;
    font-size: 16px;
  }

  th {
    background-color: #1a2f40;
    color: white;
    text-transform: uppercase;
    cursor: pointer;
  }

  tbody tr:nth-child(even) {
    background-color: #eef2f7;
  }

  tbody tr:hover {
    background-color: #dde2eb;
  }

  button, select {
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 700;
    font-size: 16px;
  }

  button {
    background-color: #dc143c;
    color: white;
    padding: 10px 15px;
    transition: background-color 0.2s ease;
  }

  button:hover {
    background-color: #a90e2e;
  }

  select {
    padding: 10px;
    border: 1px solid #ccc;
    background: white;
    text-align: center;
  }

  select:hover {
    border-color: #1a2f40;
  }

  .schema-button {
    background-color: #1a2f40;
    color: white;
    padding: 10px 15px;
    font-size: 16px;
    font-weight: 700;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  .schema-button:hover {
    background-color: #143055;
  }

  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 20px 0;
    gap: 15px;
    flex-wrap: wrap;
  }

  .pagination button {
    background-color: #dc143c;
    color: white;
    font-weight: 700;
    border-radius: 6px;
    padding: 10px 15px;
    cursor: pointer;
  }

  .pagination button.active {
    background-color: #1a2f40;
  }

  .highlight {
    background-color: #dc143c !important;
    color: white !important;
  }

  /* Мобильная версия - меняем таблицу на карточки */
  @media (max-width: 768px) {
    table, thead, tbody, th, td, tr {
      display: block;
      width: 100%;
    }

    thead tr {
      display: none;
    }

    tbody tr {
      background: white;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 12px;
      box-sizing: border-box;
      user-select: none;
    }

    tbody tr:nth-child(even),
    tbody tr:hover {
      background: white;
    }

    tbody td {
      display: flex;
      justify-content: space-between;
      padding: 6px 8px;
      border-bottom: 1px solid #ddd;
      font-weight: 700;
      font-size: 13px;
      text-align: left;
      white-space: normal;
      word-break: break-word;
    }

    tbody td:last-child {
      border-bottom: none;
    }

    tbody td::before {
      content: attr(data-label);
      font-weight: 700;
      color: #1a2f40;
      flex-basis: 40%;
      max-width: 40%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    tbody td[data-label="ОТПРАВИТЬ"]::before {
      content: none !important;
    }

    button, select, .schema-button {
      font-size: 13px;
      padding: 5px 8px;
      font-weight: 700;
    }

    tbody tr > td:last-child {
      padding: 0;
      border: none;
    }

    tbody tr > td:last-child .buttons-row {
      display: flex;
      justify-content: space-between;
      width: 100%;
      margin-top: 10px;
      gap: 10px;
    }

    tbody tr > td:last-child .buttons-row .schema-button,
    tbody tr > td:last-child .buttons-row button,
    tbody tr > td:last-child .buttons-row span.sent-text {
      flex: 1;
      max-width: 48%;
      padding: 8px 10px;
      text-align: center;
    }

    tbody tr > td:last-child .buttons-row span.sent-text {
      color: #444;
      display: inline-block;
    }
  }
</style>
</head>
<body>

<div id="app-content" style="display:none;">
  <!-- Контент будет вставлен JS -->
</div>

<script>
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbwVIBmW6gYERv1i1UeywqDY01YOIkExPrH9EG_31w1a0u3BrNVUINT1cxGpznbgc5ws/exec';

  let fullData = [];
  let currentPage = 1;
  const rowsPerPage = 20;

  let activeSearchColumn = null;
  let activeSearchText = "";

  const appContent = document.getElementById('app-content');

  function renderLayout() {
    // Единственная верстка — адаптивная, с моб стилями в CSS
    appContent.innerHTML = `
      <table>
        <thead>
          <tr>
            <th onclick="startColumnSearch(0)">ЗАДАЧА</th>
            <th onclick="startColumnSearch(1)">МАШИНА</th>
            <th onclick="startColumnSearch(2)">ОТКРЫТА</th>
            <th onclick="startColumnSearch(3)">ЗАКРЫТА</th>
            <th onclick="startColumnSearch(4)">ВЫПОЛНИЛ</th>
            <th onclick="startColumnSearch(5)">ПОЛОМКА</th>
            <th>ОТПРАВИТЬ</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>

      <div class="pagination">
        <button onclick="prevPage()" id="prevBtn" disabled>← Назад</button>
        <div id="pageNumbers"></div>
        <button onclick="nextPage()" id="nextBtn">Вперёд →</button>
      </div>
    `;
  }

  async function loadSheetData() {
    try {
      const response = await fetch(`${GAS_URL}?action=getData`);
      if (!response.ok) throw new Error('Ошибка сети');
      const data = await response.json();
      if (!Array.isArray(data)) throw new Error('Неверный формат данных');
      fullData = data;
      currentPage = 1;
      renderPage(currentPage);
      renderPageNumbers();
      appContent.style.display = "block";
    } catch (e) {
      appContent.innerHTML = `<p style="color:red; padding:20px;">Ошибка загрузки данных:<br>${e.message}</p>`;
      console.error(e);
    }
  }

  function renderPage(page) {
    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";

    if (fullData.length === 0) {
      tbody.innerHTML = `<tr><td colspan="7">Нет задач</td></tr>`;
      return;
    }

    const start = (page - 1) * rowsPerPage;
    const end = start + rowsPerPage;
    const pageData = fullData.slice(start, end);

    pageData.forEach(row => {
      // row: [rowNumber, machine, schemaLink, openDate, closeDate, doneBy, breakdown]
      const tr = document.createElement("tr");

      // Ссылка на схему
      const schemaLink = row[2]
        ? `<a href="${row[2]}" target="_blank" class="schema-button">Открыть</a>`
        : "Нет схемы";

      // Выполнил
      const doneByCell = row[5]
        ? `<td data-label="ВЫПОЛНИЛ">${row[5]}</td>`
        : `<td data-label="ВЫПОЛНИЛ" id="gText_${row[0]}">
             <select id="g_${row[0]}">
               <option value="" selected disabled></option>
               <option value="Дима">Дима</option>
               <option value="Женя">Женя</option>
             </select>
           </td>`;

      // Поломка
      const breakdownCell = row[6]
        ? `<td data-label="ПОЛОМКА">${row[6]}</td>`
        : `<td data-label="ПОЛОМКА" id="iText_${row[0]}">
             <select id="i_${row[0]}">
               <option value="" selected disabled></option>
               <option value="ЕСТЬ">ЕСТЬ</option>
               <option value="НЕТ">НЕТ</option>
             </select>
           </td>`;

      tr.innerHTML = `
        <td data-label="ЗАДАЧА">${schemaLink}</td>
        <td data-label="МАШИНА">${row[1]}</td>
        <td data-label="ОТКРЫТА">${row[3]}</td>
        <td data-label="ЗАКРЫТА">${row[4]}</td>
        ${doneByCell}
        ${breakdownCell}
        <td data-label="ОТПРАВИТЬ">
          ${row[5] && row[6]
            ? '<span class="sent-text">Отправлено</span>'
            : `<button id="btn_${row[0]}" onclick="validateAndSend(${row[0]});">Отправить</button>`
          }
        </td>
      `;

      tbody.appendChild(tr);
    });

    document.getElementById("prevBtn").disabled = page === 1;
    document.getElementById("nextBtn").disabled = page * rowsPerPage >= fullData.length;

    applyHighlight();
  }

  function renderPageNumbers() {
    const pageContainer = document.getElementById("pageNumbers");
    pageContainer.innerHTML = "";

    const totalPages = Math.ceil(fullData.length / rowsPerPage);
    if (totalPages <= 1) return;

    let startPage = Math.max(currentPage - 2, 1);
    let endPage = Math.min(startPage + 4, totalPages);

    if (endPage - startPage < 4) {
      startPage = Math.max(endPage - 4, 1);
    }

    for (let i = startPage; i <= endPage; i++) {
      const btn = document.createElement("button");
      btn.textContent = i;
      if (i === currentPage) btn.classList.add("active");
      btn.onclick = () => {
        currentPage = i;
        renderPage(currentPage);
        renderPageNumbers();
      };
      pageContainer.appendChild(btn);
    }
  }

  function nextPage() {
    if (currentPage * rowsPerPage < fullData.length) {
      currentPage++;
      renderPage(currentPage);
      renderPageNumbers();
    }
  }

  function prevPage() {
    if (currentPage > 1) {
      currentPage--;
      renderPage(currentPage);
      renderPageNumbers();
    }
  }

  async function validateAndSend(rowNumber) {
    const gSelect = document.getElementById(`g_${rowNumber}`);
    const iSelect = document.getElementById(`i_${rowNumber}`);

    if (!gSelect || !iSelect || !gSelect.value || !iSelect.value) {
      alert("Заполните все формы!");
      return;
    }

    try {
      const params = new URLSearchParams({
        action: 'update',
        rowNumber,
        doneByValue: gSelect.value,
        breakdownValue: iSelect.value
      });

      const response = await fetch(`${GAS_URL}?${params.toString()}`);
      if (!response.ok) throw new Error('Ошибка при обновлении данных');

      const updatedRow = await response.json();

      // Обновим локальные данные
      const idx = fullData.findIndex(row => row[0] === rowNumber);
      if (idx !== -1) {
        fullData[idx] = updatedRow;
      }

      renderPage(currentPage);

    } catch (e) {
      alert("Ошибка при отправке данных");
      console.error(e);
    }
  }

  function startColumnSearch(columnIndex) {
    const searchText = prompt("Введите текст для поиска:");
    if (searchText === null || searchText.trim() === "") {
      activeSearchColumn = null;
      activeSearchText = "";
      // Сброс — загрузить данные заново
      loadSheetData();
      return;
    }
    activeSearchColumn = columnIndex;
    activeSearchText = searchText.trim().toLowerCase();

    // Фильтрация данных локально
    fullData = fullData.filter(row => {
      if (!row[columnIndex]) return false;
      return row[columnIndex].toString().toLowerCase().includes(activeSearchText);
    });

    currentPage = 1;
    renderPage(currentPage);
    renderPageNumbers();
  }

  function applyHighlight() {
    if (activeSearchColumn === null || activeSearchText === "") return;

    const tbody = document.getElementById("tableBody");
    const rows = tbody.getElementsByTagName("tr");

    for (let row of rows) {
      const cells = row.getElementsByTagName("td");
      if (cells.length > activeSearchColumn) {
        const cell = cells[activeSearchColumn];
        const text = cell.textContent || cell.innerText;
        if (text.toLowerCase().includes(activeSearchText)) {
          cell.classList.add("highlight");
        } else {
          cell.classList.remove("highlight");
        }
      }
    }
  }

  window.addEventListener('resize', () => {
    // Просто для адаптивности — CSS всё сделает
  });

  window.onload = () => {
    renderLayout();
    loadSheetData();
  }
</script>

</body>
</html>
