<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SMART MAINTENANCE BOWLING</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');

    body, html {
      margin: 0; padding: 0;
      font-family: "Poppins", sans-serif;
      background-color: #f4f6f9;
      color: #1a2f40;
    }
    /* Стили для контейнера */
    #app-content {
      display: none;
    }

    /* === Стили ПК версии === */
    .desktop table {
      width: 100%;
      border-collapse: collapse;
      background-color: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .desktop th, .desktop td {
      padding: 12px;
      text-align: center;
      font-size: 16px;
      font-weight: 600;
    }
    .desktop th {
      background-color: #1a2f40;
      color: white;
      font-size: 18px;
      text-transform: uppercase;
      cursor: pointer;
    }
    .desktop tbody tr:nth-child(even) {
      background-color: #eef2f7;
    }
    .desktop tbody tr:hover {
      background-color: #dde2eb;
    }
    .desktop .schema-button {
      background-color: #1a2f40;
      color: white;
      padding: 10px 15px;
      font-size: 16px;
      font-weight: 700;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.2s ease;
    }
    .desktop .schema-button:hover {
      background-color: #143055;
    }
    .desktop select {
      width: 95%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: white;
      font-size: 16px;
      text-align: center;
    }
    .desktop select:hover {
      border-color: #1a2f40;
    }
    .desktop button {
      background-color: #dc143c;
      color: white;
      padding: 10px 15px;
      font-size: 16px;
      font-weight: 700;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .desktop button:hover {
      background-color: #a90e2e;
    }
    .desktop button:active {
      transform: scale(0.97);
    }
    .desktop .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 20px;
      gap: 20px;
      flex-wrap: wrap;
    }
    .desktop #pageNumbers button {
      background-color: #dc143c;
      color: white;
      font-weight: 700;
      border: none;
      border-radius: 6px;
      padding: 10px 15px;
      cursor: pointer;
    }
    .desktop #pageNumbers button.active {
      background-color: #1a2f40;
    }
    .desktop .highlight {
      background-color: #dc143c !important;
      color: white !important;
    }

    /* === Стили мобильной версии === */
    .mobile {
      font-size: clamp(10px, 3vw, 14px);
      font-weight: 700;
    }
    .mobile #app-content {
      width: 100%;
      padding: 10px 5px;
      box-sizing: border-box;
      max-width: 100vw;
    }
    .mobile table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      table-layout: fixed;
    }
    .mobile th, .mobile td {
      padding: 6px 8px;
      text-align: center;
      font-weight: 700;
      word-wrap: break-word;
      white-space: normal;
      font-size: clamp(10px, 2.5vw, 12px);
    }
    .mobile thead th {
      background-color: #1a2f40;
      color: white;
      cursor: pointer;
    }
    .mobile tbody tr:nth-child(even) {
      background-color: #eef2f7;
    }
    .mobile tbody tr:hover {
      background-color: #dde2eb;
    }
    .mobile .schema-button {
      background-color: #1a2f40;
      color: white;
      padding: 4px 6px;
      font-weight: 700;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: clamp(9px, 2.5vw, 12px);
      text-decoration: none;
      display: inline-block;
    }
    .mobile select, .mobile button {
      font-size: clamp(9px, 2.5vw, 12px);
      padding: 4px 6px;
      border-radius: 4px;
      font-weight: 700;
    }
    .mobile button {
      background-color: #dc143c;
      color: white;
      border: none;
      cursor: pointer;
    }
    .mobile button:hover {
      background-color: #a90e2e;
    }
    .mobile .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 15px;
      gap: 10px;
      flex-wrap: wrap;
    }
    .mobile #pageNumbers button {
      background-color: #dc143c;
      color: white;
      font-weight: 700;
      border: none;
      border-radius: 6px;
      padding: 8px 12px;
      cursor: pointer;
    }
    .mobile #pageNumbers button.active {
      background-color: #1a2f40;
    }
    .mobile .highlight {
      background-color: #dc143c !important;
      color: white !important;
    }
    /* Мобильные особенности */
    @media (max-width: 768px) {
      .mobile table, .mobile thead, .mobile tbody, .mobile th, .mobile td, .mobile tr {
        display: block;
        width: 100%;
      }
      .mobile thead tr {
        display: none;
      }
      .mobile tbody tr {
        margin-bottom: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        padding: 12px;
        box-sizing: border-box;
        user-select: none;
      }
      .mobile tbody tr:nth-child(even) {
        background-color: white;
      }
      .mobile tbody tr:hover {
        background-color: white;
      }
      .mobile tbody td:nth-child(1) {
        display: none;
      }
      .mobile tbody td {
        display: flex;
        justify-content: space-between;
        padding: 6px 8px;
        border-bottom: 1px solid #ddd;
        font-weight: 700;
        text-align: left;
        white-space: normal;
        font-size: 13px;
      }
      .mobile tbody td:last-child {
        border-bottom: none;
      }
      .mobile tbody td::before {
        content: attr(data-label);
        font-weight: 700;
        color: #1a2f40;
        flex-basis: 40%;
        max-width: 40%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .mobile tbody td[data-label="ОТПРАВИТЬ"]::before {
        content: none !important;
      }
      .mobile select, .mobile button, .mobile .schema-button {
        font-size: 13px;
        padding: 5px 8px;
        font-weight: 700;
      }
      .mobile tbody tr > td:last-child {
        padding: 0;
        border: none;
      }
      .mobile tbody tr > td:last-child .buttons-row {
        display: flex;
        justify-content: space-between;
        width: 100%;
        margin-top: 10px;
        gap: 10px;
      }
      .mobile tbody tr > td:last-child .buttons-row .schema-button {
        flex: 1;
        max-width: 48%;
        padding: 8px 10px;
        text-align: center;
      }
      .mobile tbody tr > td:last-child .buttons-row button {
        flex: 1;
        max-width: 48%;
        padding: 8px 10px;
        font-weight: 700;
      }
      .mobile tbody tr > td:last-child .buttons-row span.sent-text {
        flex: 1;
        max-width: 48%;
        padding: 8px 10px;
        font-weight: 700;
        color: #444;
        text-align: center;
        display: inline-block;
      }
    }
  </style>
</head>
<body>

<div id="app-content"></div>

<script>
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbwVIBmW6gYERv1i1UeywqDY01YOIkExPrH9EG_31w1a0u3BrNVUINT1cxGpznbgc5ws/exec';

  // Данные и переменные
  let fullData = [];
  let currentPage = 1;
  const rowsPerPage = 20;
  let activeSearchColumn = null;
  let activeSearchText = "";

  // Контейнер
  const appContent = document.getElementById('app-content');

  // Верстка ПК
  const desktopHTML = `
  <div class="desktop" style="display:block;">
    <table>
      <thead>
        <tr>
          <th onclick="startColumnSearch(0)">ЗАДАЧА</th>
          <th onclick="startColumnSearch(1)">МАШИНА</th>
          <th onclick="startColumnSearch(2)">ОТКРЫТА</th>
          <th onclick="startColumnSearch(3)">ЗАКРЫТА</th>
          <th onclick="startColumnSearch(4)">ВЫПОЛНИЛ</th>
          <th onclick="startColumnSearch(5)">ПОЛОМКА</th>
          <th>ОТПРАВИТЬ</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
    <div class="pagination">
      <button onclick="prevPage()" id="prevBtn" disabled>← Назад</button>
      <div id="pageNumbers" style="display: flex; gap: 10px;"></div>
      <button onclick="nextPage()" id="nextBtn">Вперёд →</button>
    </div>
  </div>
  `;

  // Верстка мобильная
  const mobileHTML = `
  <div class="mobile" style="display:block;">
    <div id="app-content">
      <table>
        <thead>
          <tr>
            <th onclick="startColumnSearch(0)">ЗАДАЧА</th>
            <th onclick="startColumnSearch(1)">МАШИНА</th>
            <th onclick="startColumnSearch(2)">ОТКРЫТА</th>
            <th onclick="startColumnSearch(3)">ЗАКРЫТА</th>
            <th onclick="startColumnSearch(4)">ВЫПОЛНИЛ</th>
            <th onclick="startColumnSearch(5)">ПОЛОМКА</th>
            <th>ОТПРАВИТЬ</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>

      <div class="pagination">
        <button onclick="prevPage()" id="prevBtn" disabled>← Назад</button>
        <div id="pageNumbers" style="display: flex; gap: 10px;"></div>
        <button onclick="nextPage()" id="nextBtn">Вперёд →</button>
      </div>
    </div>
  </div>
  `;

  // Вставка верстки в зависимости от ширины окна
  function renderInterface() {
    if (window.innerWidth <= 768) {
      appContent.innerHTML = mobileHTML;
    } else {
      appContent.innerHTML = desktopHTML;
    }
  }

  // Загрузка данных и запуск отображения
  async function loadSheetData() {
    try {
      const response = await fetch(`${GAS_URL}?action=getData`);
      if (!response.ok) throw new Error('Network response was not ok');
      fullData = await response.json();
      if (fullData.length === 0) {
        document.getElementById("tableBody").innerHTML = "<tr><td colspan='7'>Нет задач</td></tr>";
        return;
      }
      renderPage(currentPage);
    } catch (e) {
      document.getElementById("tableBody").innerHTML = "<tr><td colspan='7'>Ошибка загрузки данных</td></tr>";
      console.error(e);
    }
  }

  async function updateSheet(rowNumber, doneByValue, breakdownValue) {
    try {
      const params = new URLSearchParams({
        action: 'update',
        rowNumber,
        doneByValue,
        breakdownValue
      });
      const response = await fetch(`${GAS_URL}?${params.toString()}`);
      if (!response.ok) throw new Error('Network response was not ok');
      const updatedRow = await response.json();

      const index = fullData.findIndex(row => row[0] === rowNumber);
      if (index !== -1) {
        fullData[index] = updatedRow;
      }
      renderPage(currentPage);
    } catch (e) {
      alert('Ошибка при обновлении данных');
      console.error(e);
    }
  }

  function renderPage(page) {
    const tableBody = document.getElementById("tableBody");
    tableBody.innerHTML = "";

    const start = (page - 1) * rowsPerPage;
    const end = start + rowsPerPage;
    const pageData = fullData.slice(start, end);

    const isMobile = window.innerWidth <= 768;

    pageData.forEach((row) => {
      const tr = document.createElement("tr");

      if (!isMobile) {
        // ПК-версия
        const schemaLink = row[2]
          ? `<a href="${row[2]}" target="_blank"><button class="schema-button">Открыть</button></a>`
          : "Нет схемы";

        tr.innerHTML = `
          <td>${schemaLink}</td>
          <td>${row[1]}</td>
          <td>${row[3]}</td>
          <td>${row[4]}</td>
          ${row[5]
            ? `<td>${row[5]}</td>`
            : `<td id="gText_${row[0]}">
                <select id="g_${row[0]}">
                  <option value="" selected disabled></option>
                  <option value="Дима">Дима</option>
                  <option value="Женя">Женя</option>
                </select>
              </td>`
          }
          ${row[6]
            ? `<td>${row[6]}</td>`
            : `<td id="iText_${row[0]}">
                <select id="i_${row[0]}">
                  <option value="" selected disabled></option>
                  <option value="ЕСТЬ">ЕСТЬ</option>
                  <option value="НЕТ">НЕТ</option>
                </select>
              </td>`
          }
          <td><button id="btn_${row[0]}" onclick="validateAndSend(${row[0]});">Отправить</button></td>
        `;
      } else {
        // Мобильная версия
        const schemaButton = row[2]
          ? `<button class="schema-button" onclick="window.open('${row[2]}', '_blank')">Открыть</button>`
          : "Нет схемы";

        tr.innerHTML = `
          <td data-label="ЗАДАЧА">${schemaButton}</td>
          <td data-label="МАШИНА">${row[1]}</td>
          <td data-label="ОТКРЫТА">${row[3]}</td>
          <td data-label="ЗАКРЫТА">${row[4]}</td>
          ${row[5]
            ? `<td data-label="ВЫПОЛНИЛ">${row[5]}</td>`
            : `<td data-label="ВЫПОЛНИЛ" id="gText_${row[0]}">
                <select id="g_${row[0]}">
                  <option value="" selected disabled></option>
                  <option value="Дима">Дима</option>
                  <option value="Женя">Женя</option>
                </select>
              </td>`
          }
          ${row[6]
            ? `<td data-label="ПОЛОМКА">${row[6]}</td>`
            : `<td data-label="ПОЛОМКА" id="iText_${row[0]}">
                <select id="i_${row[0]}">
                  <option value="" selected disabled></option>
                  <option value="ЕСТЬ">ЕСТЬ</option>
                  <option value="НЕТ">НЕТ</option>
                </select>
              </td>`
          }
          <td data-label="ОТПРАВИТЬ">
            <div class="buttons-row">
              ${schemaButton}
              <button id="btn_${row[0]}" onclick="validateAndSend(${row[0]});">Отправить</button>
            </div>
          </td>
        `;
      }

      tableBody.appendChild(tr);
    });

    applyHighlight();
    renderPageNumbers();

    document.getElementById("prevBtn").disabled = currentPage === 1;
    document.getElementById("nextBtn").disabled = currentPage * rowsPerPage >= fullData.length;
  }

  function renderPageNumbers() {
    const pageContainer = document.getElementById("pageNumbers");
    pageContainer.innerHTML = "";
    const totalPages = Math.ceil(fullData.length / rowsPerPage);

    for(let i = 1; i <= totalPages; i++) {
      const btn = document.createElement("button");
      btn.innerText = i;
      if(i === currentPage) btn.classList.add("active");
      btn.onclick = () => {
        currentPage = i;
        renderPage(currentPage);
      };
      pageContainer.appendChild(btn);
    }
  }

  function prevPage() {
    if (currentPage > 1) {
      currentPage--;
      renderPage(currentPage);
    }
  }

  function nextPage() {
    if (currentPage * rowsPerPage < fullData.length) {
      currentPage++;
      renderPage(currentPage);
    }
  }

  // Поиск по колонке
  function startColumnSearch(colIndex) {
    if (activeSearchColumn === colIndex) {
      activeSearchColumn = null;
      activeSearchText = "";
      fullData = [...fullDataUnfiltered];
      renderPage(1);
      return;
    }
    activeSearchColumn = colIndex;
    const searchTerm = prompt("Введите поисковый текст для колонки:");
    if (searchTerm === null) return;
    activeSearchText = searchTerm.trim().toLowerCase();
    filterDataByColumn(activeSearchColumn, activeSearchText);
  }

  let fullDataUnfiltered = [];

  function filterDataByColumn(colIndex, searchText) {
    fullData = fullDataUnfiltered.filter(row => {
      if (!row[colIndex]) return false;
      return row[colIndex].toString().toLowerCase().includes(searchText);
    });
    currentPage = 1;
    renderPage(currentPage);
  }

  function applyHighlight() {
    if (activeSearchColumn === null || activeSearchText === "") return;
    const tableBody = document.getElementById("tableBody");
    for(const row of tableBody.children) {
      const cell = row.children[activeSearchColumn];
      if(!cell) continue;
      const text = cell.textContent.toLowerCase();
      if(text.includes(activeSearchText)) {
        cell.classList.add("highlight");
      } else {
        cell.classList.remove("highlight");
      }
    }
  }

  // Валидация и отправка изменений
  function validateAndSend(rowNumber) {
    const gSelect = document.getElementById(`g_${rowNumber}`);
    const iSelect = document.getElementById(`i_${rowNumber}`);
    const doneByValue = gSelect ? gSelect.value : null;
    const breakdownValue = iSelect ? iSelect.value : null;

    if (!doneByValue || !breakdownValue) {
      alert("Пожалуйста, выберите 'Выполнил' и 'Поломка' перед отправкой");
      return;
    }

    updateSheet(rowNumber, doneByValue, breakdownValue);
  }

  // Перезагрузка интерфейса при изменении размера экрана
  window.addEventListener("resize", () => {
    // Чтобы не перерисовывать слишком часто — debounce
    clearTimeout(window.resizeTimeout);
    window.resizeTimeout = setTimeout(() => {
      renderInterface();
      renderPage(currentPage);
    }, 300);
  });

  // Загрузка данных с сайта и инициализация
  async function init() {
    renderInterface();
    try {
      const response = await fetch(`${GAS_URL}?action=getData`);
      if(!response.ok) throw new Error('Ошибка сети');
      fullDataUnfiltered = await response.json();
      fullData = [...fullDataUnfiltered];
      renderPage(currentPage);
    } catch(e) {
      appContent.innerHTML = `<p style="padding: 20px; color: red;">Ошибка загрузки данных: ${e.message}</p>`;
      console.error(e);
    }
  }

  window.onload = init;
</script>

</body>
</html>
